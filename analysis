#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <cleaned_tsv_file>" >&2
  exit 1
fi

file="$1"
if [ ! -f "$file" ]; then
  echo "Error: '$file' not found." >&2
  exit 1
fi

# 1) Most popular mechanics (column 13)
read mech_name mech_count <<< "$(
  awk -F'\t' '
    NR>1 && $13 != "" {
      n = split($13, arr, ",")
      for (i=1; i<=n; i++) {
        m = arr[i]; gsub(/^[[:space:]]+|[[:space:]]+$/, "", m)
        mech[m]++
      }
    }
    END {
      max=0
      for (m in mech)
        if (mech[m] > max) { max = mech[m]; best = m }
      printf("%s %d", best, max)
    }
  ' "$file"
)"

# 2) Most popular domain (column 14)
read dom_name dom_count <<< "$(
  awk -F'\t' '
    NR>1 && $14 != "" {
      n = split($14, arr, ",")
      for (i=1; i<=n; i++) {
        d = arr[i]; gsub(/^[[:space:]]+|[[:space:]]+$/, "", d)
        dom[d]++
      }
    }
    END {
      max=0
      for (d in dom)
        if (dom[d] > max) { max = dom[d]; best = d }
      printf("%s %d", best, max)
    }
  ' "$file"
)"

# 3) Correlation: year (col 3) vs rating (col 9)
r1="$(
  awk -F'\t' '
    NR>1 && $3 ~ /^[0-9]+$/ && $9 ~ /^[0-9]+(\.[0-9]+)?$/ {
      x=$3; y=$9
      n++; sx+=x; sy+=y; sxy+=x*y; sx2+=x*x; sy2+=y*y
    }
    END {
      num = n*sxy - sx*sy
      den = sqrt((n*sx2 - sx^2)*(n*sy2 - sy^2))
      printf("%.3f", (den>0 ? num/den : 0))
    }
  ' "$file"
)"

# 4) Correlation: complexity (col 11) vs rating (col 9)
r2="$(
  awk -F'\t' '
    NR>1 && $11 ~ /^[0-9]+(\.[0-9]+)?$/ && $9 ~ /^[0-9]+(\.[0-9]+)?$/ {
      x=$11; y=$9
      n++; sx+=x; sy+=y; sxy+=x*y; sx2+=x*x; sy2+=y*y
    }
    END {
      num = n*sxy - sx*sy
      den = sqrt((n*sx2 - sx^2)*(n*sy2 - sy^2))
      printf("%.3f", (den>0 ? num/den : 0))
    }
  ' "$file"
)"

# 5) Print
echo "The most popular game mechanics is $mech_name found in $mech_count games"
echo "The most popular game domain is $dom_name found in $dom_count games"
echo
echo "The correlation between the year of publication and the average rating is $r1"
echo "The correlation between the complexity of a game and the average rating is $r2"
